name: CI - SAST & DAST

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  security:
    runs-on: ubuntu-latest
    env:
      APP_PORT: 8080
      APP_URL: http://localhost:8080

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------- Setup Java --------------------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # -------------------- Sanity: Sonar connectivity --------------------
      - name: Check Sonar connectivity (debug)
        if: ${{ secrets.SONAR_HOST_URL != '' }}
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          echo "Testing Sonar URL: $SONAR_HOST_URL"
          curl -v --fail --max-time 10 "$SONAR_HOST_URL/api/server/version" || echo "Sonar not reachable (will fail later if required)."

      # -------------------- SAST: SonarQube Scan --------------------
      - name: Run SonarQube Scanner
        uses: sonarsource/sonarqube-scan-action@v2
        with:
          projectBaseDir: .
          args: >
            -Dsonar.projectKey=antrian-app
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }}
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

      # Debug: show .scannerwork & report-task.txt (helps to diagnose Quality Gate step)
      - name: Show Sonar scanner metadata (debug)
        if: always()
        run: |
          echo "PWD: $(pwd)"
          echo "Listing .scannerwork if exists:"
          ls -la .scannerwork || true
          if [ -f ".scannerwork/report-task.txt" ]; then
            echo "---- report-task.txt ----"
            sed -n '1,200p' .scannerwork/report-task.txt
          else
            echo ".scannerwork/report-task.txt not found"
          fi

      # -------------------- Sonar Quality Gate (strict) --------------------
      - name: Wait for SonarQube Quality Gate
        uses: sonarsource/sonarqube-quality-gate-action@v1
        with:
          scanMetadataReportFile: .scannerwork/report-task.txt
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      # Optional: print JSON status for easier debugging (only runs if previous step succeeded or failed)
      - name: Print Quality Gate JSON (debug)
        if: always()
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          if [ -f ".scannerwork/report-task.txt" ]; then
            ANALYSIS_ID=$(sed -n 's/^analysisId=//p' .scannerwork/report-task.txt)
            echo "Analysis ID: $ANALYSIS_ID"
            echo "Quality Gate API result:"
            curl -s -u "${SONAR_TOKEN}:" "${SONAR_HOST_URL}/api/qualitygates/project_status?analysisId=${ANALYSIS_ID}" | jq . || true
          else
            echo "No report-task.txt to query Quality Gate."
          fi

      # -------------------- Build & Run App Container --------------------
      - name: Build Docker image for app
        run: docker build -t antrian-app .

      - name: Run app container
        run: docker run -d --name antrian -p 8080:80 antrian-app

      - name: Wait for app to be healthy
        run: |
          echo "Waiting for ${APP_URL} to respond..."
          for i in {1..30}; do
            if curl -sSf "${{ env.APP_URL }}" >/dev/null 2>&1; then
              echo "App is up"
              exit 0
            fi
            echo "Waiting... ($i)"
            sleep 2
          done
          echo "App did not start in time" && exit 1

      - name: App quick check (from runner)
        run: |
          echo "curl headers:"
          curl -I --max-time 10 "${{ env.APP_URL }}" || true

      # -------------------- Prepare workspace for ZAP --------------------
      - name: Make workspace writable for ZAP (if permissions block)
        run: |
          echo "Adjusting permissions for workspace so ZAP can write reports"
          sudo chmod -R a+rw "${{ github.workspace }}" || true

      # -------------------- DAST: Run OWASP ZAP (host network) --------------------
      - name: Pull ZAP image
        run: docker pull ghcr.io/zaproxy/zaproxy:stable

      - name: Run ZAP Baseline Scan (host network)
        run: |
          docker run --rm -u root --network host -v "${{ github.workspace }}":/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py -t "${{ env.APP_URL }}" -r zap_report.html

      - name: Upload ZAP report
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: zap_report.html

      - name: Show ZAP report snippet (debug)
        if: always()
        run: |
          if [ -f "zap_report.html" ]; then
            echo "ZAP report exists, showing first 200 lines:"
            sed -n '1,200p' zap_report.html || true
          else
            echo "zap_report.html not found"
          fi

    # -------------------- Cleanup (always) --------------------
    post:
      always:
        - name: Stop and remove containers
          run: |
            echo "Cleaning up containers..."
            docker rm -f antrian || true
