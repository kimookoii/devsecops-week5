name: CI - SAST & DAST

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  security:
    runs-on: ubuntu-latest
    env:
      APP_PORT: 8080
      APP_URL: http://localhost:8080

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install utils
        run: sudo apt-get update && sudo apt-get install -y jq curl || true

      # -------------------- Setup Java --------------------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # -------------------- Sanity: Sonar connectivity (debug) --------------------
      - name: Check Sonar connectivity (debug)
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          if [ -z "${SONAR_HOST_URL}" ]; then
            echo "SONAR_HOST_URL not set (secret missing). Skipping remote Sonar connectivity check."
          else
            echo "Testing Sonar URL: ${SONAR_HOST_URL}"
            curl -v --fail --max-time 10 "${SONAR_HOST_URL}/api/server/version" || echo "Sonar not reachable (will fail later if required)."
          fi

      # -------------------- SAST: SonarQube Scan --------------------
      - name: Run SonarQube Scanner
        uses: sonarsource/sonarqube-scan-action@v2
        with:
          projectBaseDir: .
          args: >
            -Dsonar.projectKey=antrian-app
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }}
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

      - name: Show Sonar scanner metadata (debug)
        if: always()
        run: |
          echo "PWD: $(pwd)"
          echo "Listing .scannerwork if exists:"
          ls -la .scannerwork || true
          if [ -f ".scannerwork/report-task.txt" ]; then
            echo "---- report-task.txt ----"
            sed -n '1,200p' .scannerwork/report-task.txt
          else
            echo ".scannerwork/report-task.txt not found"
          fi

      # -------------------- Sonar Quality Gate (non-blocking for tests) --------------------
      - name: Wait for SonarQube Quality Gate (non-blocking)
        continue-on-error: true
        uses: sonarsource/sonarqube-quality-gate-action@v1
        with:
          scanMetadataReportFile: .scannerwork/report-task.txt
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: Print Quality Gate JSON (debug)
        if: always()
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          if [ -f ".scannerwork/report-task.txt" ]; then
            ANALYSIS_ID=$(sed -n 's/^analysisId=//p' .scannerwork/report-task.txt)
            if [ -n "$ANALYSIS_ID" ]; then
              echo "Analysis ID: $ANALYSIS_ID"
              echo "Quality Gate API result (may be stale/fail if server unreachable):"
              curl -s -u "${SONAR_TOKEN}:" "${SONAR_HOST_URL}/api/qualitygates/project_status?analysisId=${ANALYSIS_ID}" | jq . || true
            else
              echo "analysisId not found in report-task.txt"
            fi
          else
            echo "No report-task.txt to query Quality Gate."
          fi

      # -------------------- Build & Run App Container --------------------
      - name: Build Docker image for app
        run: docker build -t antrian-app .

      - name: Run app container
        run: docker run -d --name antrian -p 8080:80 antrian-app

      - name: Wait for app to be healthy
        run: |
          echo "Waiting for ${APP_URL} to respond..."
          for i in {1..30}; do
            if curl -sSf "${{ env.APP_URL }}" >/dev/null 2>&1; then
              echo "App is up"
              exit 0
            fi
            echo "Waiting... ($i)"
            sleep 2
          done
          echo "App did not start in time" && exit 1

      - name: App quick check (from runner)
        run: |
          echo "curl headers:"
          curl -I --max-time 10 "${{ env.APP_URL }}" || true

      # -------------------- Prepare workspace for ZAP --------------------
      - name: Make workspace writable for ZAP (if permissions block)
        run: |
          echo "Adjusting permissions for workspace so ZAP can write reports"
          sudo chmod -R a+rw "${{ github.workspace }}" || true

      # -------------------- DAST: Run OWASP ZAP (host network) --------------------
      - name: Pull ZAP image
        run: docker pull ghcr.io/zaproxy/zaproxy:stable

      - name: Run ZAP Baseline (ignore non-zero exit)
        run: |
          set +e
          docker run --rm -u root --network host -v "${{ github.workspace }}":/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py -t "${{ env.APP_URL }}" -r zap_report.html || true
          set -e

      # -------------------- Always upload ZAP report so testers can inspect --------------------
      - name: Upload ZAP report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: zap_report.html

      - name: Print ZAP High Alerts (debug)
        if: always()
        run: |
          if [ -f "zap_report.html" ]; then
            echo "=== ZAP High Alerts (first hits) ==="
            grep -n -C3 "High" zap_report.html || true
          else
            echo "No zap_report.html"
          fi

      # Non-fatal: do not fail the job based on ZAP High (suitable for testers)
      - name: Fail if ZAP found High (non-fatal)
        continue-on-error: true
        run: |
          if [ -f "zap_report.html" ] && grep -q "High" zap_report.html; then
            echo "High risk found (non-fatal in this workflow). See zap-report artifact for details."
            exit 1
          else
            echo "No High risk found; continuing."
          fi

      - name: Show ZAP report snippet (debug)
        if: always()
        run: |
          if [ -f "zap_report.html" ]; then
            echo "ZAP report exists, showing first 200 lines:"
            sed -n '1,200p' zap_report.html || true
          else
            echo "zap_report.html not found"
          fi

      # -------------------- Cleanup (always run) --------------------
      - name: Stop and remove containers
        if: always()
        run: |
          echo "Cleaning up containers..."
          docker rm -f antrian || true
